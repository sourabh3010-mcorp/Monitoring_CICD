{
  "contentVersion": "1.0.0.0",
  "parameters": {
    "workbookDisplayName": {
      "type": "string",
      "defaultValue": "Health score",
      "metadata": {
        "description": "The friendly name for the workbook that is used in the Gallery or Saved List.  This name must be unique within a resource group."
      }
    },
    "workbookType": {
      "type": "string",
      "defaultValue": "workbook",
      "metadata": {
        "description": "The gallery that the workbook will been shown under. Supported values include workbook, tsg, etc. Usually, this is 'workbook'"
      }
    },
    "workbookSourceId": {
      "type": "string",
      "defaultValue": "azure monitor",
      "metadata": {
        "description": "The id of resource instance to which the workbook will be associated"
      }
    },
    "workbookId": {
      "type": "string",
      "defaultValue": "[newGuid()]",
      "metadata": {
        "description": "The unique guid for this workbook instance"
      }
    }
  },
  "resources": [
    {
      "name": "[parameters('workbookId')]",
      "type": "microsoft.insights/workbooks",
      "location": "[resourceGroup().location]",
      "apiVersion": "2018-06-17-preview",
      "dependsOn": [],
      "kind": "shared",
      "properties": {
        "displayName": "[parameters('workbookDisplayName')]",
        "serializedData": "{\"version\":\"Notebook/1.0\",\"items\":[{\"type\":1,\"content\":{\"json\":\"  <a href=\\\"https://portal.azure.com/#@globant.com/resource/subscriptions/2a2d0d74-7f86-4edd-bdf5-1f127a432867/resourceGroups/App-grp/providers/microsoft.insights/workbooks/da17fde5-9e45-4ae1-835a-109da876703d/workbook?AppName=notification-api\\\" \\n     target=\\\"_blank\\\" \\n     style=\\\"background-color:#0078D4; color:white; padding:10px; border-radius:5px; text-decoration:none; display:block;\\\">\\n     Application A\\n  </a>\"},\"name\":\"text - 9\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"let appFilter = \\\"App-A\\\";\\nApplicationHealth_CL\\n| where AppName_s == appFilter\\n| summarize AvgHealthScore = avg(HealthScore_d) by AppName_s\\n| extend \\n    Status = case(\\n        AvgHealthScore > 50, \\\"Healthy\\\",\\n        \\\"Critical\\\"\\n    )\\n| project AppName_s, AvgHealthScore, Status\",\"size\":4,\"timeContext\":{\"durationMs\":2592000000},\"exportedParameters\":[{\"parameterType\":1},{\"fieldName\":\"AppName_s\",\"parameterName\":\"AppName_s\",\"parameterType\":1,\"defaultValue\":\"App-A\"}],\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"/subscriptions/2a2d0d74-7f86-4edd-bdf5-1f127a432867/resourceGroups/rg-monitoring-demo/providers/Microsoft.OperationalInsights/workspaces/law-monitoring-demo\"],\"visualization\":\"stat\",\"statSettings\":{\"valueField\":\"Status\",\"valueAggregation\":\"None\",\"colorSettings\":{\"type\":\"thresholds\",\"mode\":\"background\",\"heatmapPalette\":\"greenRed\",\"thresholdsGrid\":[{\"sourceColumn\":\"Status\",\"operator\":\"contains\",\"thresholdValue\":\"Healthy\",\"representation\":\"green\"},{\"sourceColumn\":\"Status\",\"operator\":\"contains\",\"thresholdValue\":\"Critical\",\"representation\":\"redBright\"}]},\"iconSettings\":{\"thresholdsGrid\":[{\"sourceColumn\":\"Status\",\"operator\":\"contains\",\"thresholdValue\":\"Healthy\",\"representation\":\"success\"},{\"operator\":\"contains\",\"thresholdValue\":\"Critical\",\"representation\":\"4\"}]},\"tagText\":\"\",\"valueFontStyle\":\"auto\",\"linkSettings\":{\"linkTarget\":\"WorkbookTemplate\",\"workbookContext\":{\"componentIdSource\":\"workbook\",\"resourceIdsSource\":\"default\",\"templateIdSource\":\"static\",\"templateId\":\"/subscriptions/2a2d0d74-7f86-4edd-bdf5-1f127a432867/resourceGroups/app-grp/providers/microsoft.insights/workbooks/27ca27dd-1201-4832-8d7d-580b81b35170\",\"typeSource\":\"workbook\",\"gallerySource\":\"workbook\",\"locationSource\":\"default\",\"workbookName\":\"MoneyCorpView\",\"viewerMode\":true}}}},\"name\":\"query - 3\"},{\"type\":1,\"content\":{\"json\":\"App B\"},\"name\":\"text - 8\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"let appFilter = \\\"App-C\\\";\\nApplicationHealth_CL\\n| where AppName_s == appFilter\\n| summarize AvgHealthScore = avg(HealthScore_d) by AppName_s\\n| extend \\n    Status = case(\\n        AvgHealthScore > 50, \\\"Healthy\\\",\\n        \\\"Critical\\\"\\n    )\\n| project AppName_s, AvgHealthScore, Status\",\"size\":4,\"title\":\"App-B\",\"timeContext\":{\"durationMs\":2592000000},\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"/subscriptions/2a2d0d74-7f86-4edd-bdf5-1f127a432867/resourceGroups/rg-monitoring-demo/providers/Microsoft.OperationalInsights/workspaces/law-monitoring-demo\"],\"visualization\":\"stat\",\"statSettings\":{\"valueField\":\"Status\",\"valueAggregation\":\"None\",\"colorSettings\":{\"type\":\"thresholds\",\"mode\":\"background\",\"heatmapPalette\":\"greenRed\",\"thresholdsGrid\":[{\"sourceColumn\":\"Status\",\"operator\":\"contains\",\"thresholdValue\":\"Healthy\",\"representation\":\"green\"},{\"sourceColumn\":\"Status\",\"operator\":\"contains\",\"thresholdValue\":\"Critical\",\"representation\":\"redBright\"}]},\"iconSettings\":{\"thresholdsGrid\":[{\"sourceColumn\":\"Status\",\"operator\":\"contains\",\"thresholdValue\":\"Healthy\",\"representation\":\"success\"},{\"operator\":\"contains\",\"thresholdValue\":\"Critical\",\"representation\":\"4\"}]},\"tagText\":\"\",\"valueFontStyle\":\"auto\",\"linkSettings\":{\"linkTarget\":\"WorkbookTemplate\",\"linkIsContextBlade\":false,\"workbookContext\":{\"componentIdSource\":\"workbook\",\"resourceIdsSource\":\"default\",\"templateIdSource\":\"static\",\"templateId\":\"/subscriptions/2a2d0d74-7f86-4edd-bdf5-1f127a432867/resourceGroups/app-grp/providers/microsoft.insights/workbooks/27ca27dd-1201-4832-8d7d-580b81b35170\",\"typeSource\":\"workbook\",\"gallerySource\":\"workbook\",\"locationSource\":\"default\",\"workbookName\":\"MoneyCorpView\",\"viewerMode\":true}}}},\"name\":\"query - 3 - Copy - Copy\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"\\nApplicationHealth_CL\\n| summarize AvgHealthScore = avg(HealthScore_d) by AppName_s\\n| extend \\n    Status = case(\\n        AvgHealthScore > 50, \\\"Healthy\\\",\\n        \\\"ðŸ”´ Critical\\\"\\n    )\\n| project AppName_s, AvgHealthScore, Status\\n\",\"size\":4,\"title\":\"App-C\",\"timeContext\":{\"durationMs\":604800000},\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"/subscriptions/2a2d0d74-7f86-4edd-bdf5-1f127a432867/resourceGroups/rg-monitoring-demo/providers/Microsoft.OperationalInsights/workspaces/law-monitoring-demo\"],\"visualization\":\"stat\",\"tileSettings\":{\"titleContent\":{\"columnMatch\":\"AppName_s\",\"formatter\":1},\"leftContent\":{\"columnMatch\":\"AvgHealthScore\",\"formatter\":12,\"formatOptions\":{\"min\":0,\"max\":100,\"palette\":\"redGreen\",\"linkTarget\":\"CellDetails\",\"linkIsContextBlade\":true,\"compositeBarSettings\":{\"labelText\":\"\",\"columnSettings\":[]}},\"numberFormat\":{\"unit\":17,\"options\":{\"style\":\"decimal\",\"maximumFractionDigits\":2,\"maximumSignificantDigits\":3}}},\"rightContent\":{\"columnMatch\":\"Status\",\"formatter\":12,\"formatOptions\":{\"palette\":\"none\"}},\"showBorder\":false,\"size\":\"auto\"},\"statSettings\":{\"valueField\":\"Status\",\"valueAggregation\":\"None\",\"linkSettings\":{\"linkTarget\":\"WorkbookTemplate\",\"linkIsContextBlade\":false,\"workbookContext\":{\"componentIdSource\":\"workbook\",\"resourceIdsSource\":\"default\",\"templateIdSource\":\"static\",\"templateId\":\"/subscriptions/2a2d0d74-7f86-4edd-bdf5-1f127a432867/resourceGroups/app-grp/providers/microsoft.insights/workbooks/27ca27dd-1201-4832-8d7d-580b81b35170\",\"typeSource\":\"workbook\",\"gallerySource\":\"workbook\",\"locationSource\":\"default\",\"workbookName\":\"MoneyCorpView\",\"viewerMode\":true}},\"colorSettings\":{\"type\":\"thresholds\",\"mode\":\"background\",\"heatmapPalette\":\"greenRed\",\"thresholdsGrid\":[{\"sourceColumn\":\"Status\",\"operator\":\"contains\",\"thresholdValue\":\"Healthy\",\"representation\":\"green\"},{\"sourceColumn\":\"Status\",\"operator\":\"contains\",\"thresholdValue\":\"Critical\",\"representation\":\"redBright\"}]},\"iconSettings\":{\"thresholdsGrid\":[{\"sourceColumn\":\"Status\",\"operator\":\"contains\",\"thresholdValue\":\"Healthy\",\"representation\":\"success\"},{\"sourceColumn\":\"Status\",\"thresholdValue\":\"Critical\",\"representation\":\"failed\"}]},\"tagText\":\"\",\"valueFontStyle\":\"auto\"}},\"name\":\"query - 2\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"\\nApplicationHealth_CL\\n| summarize AvgHealthScore = avg(HealthScore_d) by AppName_s\\n| sort by AppName_s asc\\n| extend \\n    Status = case(\\n        AvgHealthScore > 50, \\\"ðŸŸ¢ Healthy\\\",\\n        \\\"ðŸ”´ Critical\\\"\\n    )\\n| project AppName_s, AvgHealthScore, Status\\n\",\"size\":4,\"timeContext\":{\"durationMs\":604800000},\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"/subscriptions/2a2d0d74-7f86-4edd-bdf5-1f127a432867/resourceGroups/rg-monitoring-demo/providers/Microsoft.OperationalInsights/workspaces/law-monitoring-demo\"],\"visualization\":\"tiles\",\"tileSettings\":{\"titleContent\":{\"columnMatch\":\"AppName_s\",\"formatter\":1},\"leftContent\":{\"columnMatch\":\"AvgHealthScore\",\"formatter\":12,\"formatOptions\":{\"min\":0,\"max\":100,\"palette\":\"redGreen\",\"linkTarget\":\"CellDetails\",\"linkIsContextBlade\":true,\"compositeBarSettings\":{\"labelText\":\"\",\"columnSettings\":[]}},\"numberFormat\":{\"unit\":17,\"options\":{\"style\":\"decimal\",\"maximumFractionDigits\":2,\"maximumSignificantDigits\":3}}},\"rightContent\":{\"columnMatch\":\"Status\",\"formatter\":12,\"formatOptions\":{\"palette\":\"none\"}},\"showBorder\":true,\"size\":\"auto\",\"styleSettings\":{\"borderStyle\":\"shadow\",\"backgroundColor\":\"colorGray300\"}},\"statSettings\":{\"valueField\":\"Status\",\"valueAggregation\":\"None\",\"linkSettings\":{\"linkTarget\":\"WorkbookTemplate\"},\"colorSettings\":{\"type\":\"thresholds\",\"mode\":\"background\",\"heatmapPalette\":\"greenRed\",\"thresholdsGrid\":[{\"sourceColumn\":\"Status\",\"operator\":\"contains\",\"thresholdValue\":\"Healthy\",\"representation\":\"green\"},{\"sourceColumn\":\"Status\",\"operator\":\"contains\",\"thresholdValue\":\"Critical\",\"representation\":\"redBright\"}]},\"iconSettings\":{\"thresholdsGrid\":[{\"sourceColumn\":\"Status\",\"operator\":\"contains\",\"thresholdValue\":\"Healthy\",\"representation\":\"success\"},{\"sourceColumn\":\"Status\",\"thresholdValue\":\"Critical\",\"representation\":\"failed\"}]},\"tagText\":\"\",\"valueFontStyle\":\"auto\"}},\"name\":\"query - 2 - Copy\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"let criticalWeight = 50;\\nlet errorWeight = 20;\\nlet warningWeight = 5;\\nApplicationHealth_CL\\n| where TimeGenerated > ago(1h)\\n| where AppName_s == \\\"App-A\\\"\\n| summarize \\n    CriticalCount = countif(Severity_s == \\\"Critical\\\"),\\n    ErrorCount = countif(Severity_s == \\\"Error\\\"),\\n    WarningCount = countif(Severity_s == \\\"Warning\\\")\\n| extend HealthScore = 100 - ((CriticalCount * criticalWeight) + (ErrorCount * errorWeight) + (WarningCount * warningWeight))\\n| project HealthScore = iff(HealthScore < 0, 0, HealthScore)\\n\",\"size\":4,\"title\":\"App-A Health score\",\"timeContext\":{\"durationMs\":86400000},\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"/subscriptions/2a2d0d74-7f86-4edd-bdf5-1f127a432867/resourceGroups/rg-monitoring-demo/providers/Microsoft.OperationalInsights/workspaces/law-monitoring-demo\"],\"visualization\":\"tiles\",\"tileSettings\":{\"titleContent\":{},\"subtitleContent\":{\"columnMatch\":\"HealthScore\",\"formatter\":12,\"formatOptions\":{\"palette\":\"auto\"}},\"showBorder\":false}},\"name\":\"query - 0\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"let selectedApp = '{AplicationName}';\\nApplicationHealth_CL\\n| where AppName_s == appFilter\\n| summarize AvgHealthScore = avg(HealthScore_d) by AppName_s\\n| extend \\n    Status = case(\\n        AvgHealthScore > 50, \\\"Healthy\\\",\\n        \\\"Critical\\\"\\n    )\\n| project AppName_s, AvgHealthScore, Status\",\"size\":4,\"timeContext\":{\"durationMs\":2592000000},\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"/subscriptions/2a2d0d74-7f86-4edd-bdf5-1f127a432867/resourceGroups/rg-monitoring-demo/providers/Microsoft.OperationalInsights/workspaces/law-monitoring-demo\"],\"visualization\":\"stat\",\"statSettings\":{\"valueField\":\"Status\",\"valueAggregation\":\"None\",\"colorSettings\":{\"type\":\"thresholds\",\"mode\":\"background\",\"heatmapPalette\":\"greenRed\",\"thresholdsGrid\":[{\"sourceColumn\":\"Status\",\"operator\":\"contains\",\"thresholdValue\":\"Healthy\",\"representation\":\"green\"},{\"sourceColumn\":\"Status\",\"operator\":\"contains\",\"thresholdValue\":\"Critical\",\"representation\":\"redBright\"}]},\"iconSettings\":{\"thresholdsGrid\":[{\"sourceColumn\":\"Status\",\"operator\":\"contains\",\"thresholdValue\":\"Healthy\",\"representation\":\"success\"},{\"operator\":\"contains\",\"thresholdValue\":\"Critical\",\"representation\":\"4\"}]},\"tagText\":\"\",\"valueFontStyle\":\"auto\"}},\"name\":\"query - 3 - Copy\"},{\"type\":9,\"content\":{\"version\":\"KqlParameterItem/1.0\",\"parameters\":[],\"style\":\"pills\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"},\"name\":\"parameters - 10\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"let appFilter = \\\"App-A\\\";\\nApplicationHealth_CL\\n| where AppName_s == appFilter\\n| summarize AvgHealthScore = avg(HealthScore_d) by AppName_s\\n| extend \\n    Status = case(\\n        AvgHealthScore > 70, \\\"ðŸŸ¢ Healthy\\\",\\n        \\\"ðŸ”´ Critical\\\"\\n    )\\n| project AppName_s, AvgHealthScore, Status\\n\",\"size\":2,\"timeContext\":{\"durationMs\":2592000000},\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"/subscriptions/2a2d0d74-7f86-4edd-bdf5-1f127a432867/resourceGroups/rg-monitoring-demo/providers/Microsoft.OperationalInsights/workspaces/law-monitoring-demo\"],\"visualization\":\"tiles\",\"tileSettings\":{\"titleContent\":{\"columnMatch\":\"AppName_s\",\"formatter\":1},\"leftContent\":{\"columnMatch\":\"AvgHealthScore\",\"formatter\":12,\"formatOptions\":{\"palette\":\"auto\"},\"numberFormat\":{\"unit\":17,\"options\":{\"style\":\"decimal\",\"maximumFractionDigits\":2,\"maximumSignificantDigits\":3}}},\"rightContent\":{\"columnMatch\":\"Status\",\"formatter\":12,\"formatOptions\":{\"palette\":\"blue\"}},\"showBorder\":false,\"size\":\"full\"}},\"name\":\"query - 1\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"let appFilter = \\\"App-A\\\";\\nApplicationHealth_CL\\n| where AppName_s == appFilter\\n| summarize AvgHealthScore = avg(HealthScore_d) by AppName_s\\n| extend \\n    Status = case(\\n        AvgHealthScore > 50, \\\"Healthy\\\",\\n        \\\"Critical\\\"\\n    )\\n| project AppName_s, AvgHealthScore, Status\",\"size\":4,\"timeContext\":{\"durationMs\":2592000000},\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"/subscriptions/2a2d0d74-7f86-4edd-bdf5-1f127a432867/resourceGroups/rg-monitoring-demo/providers/Microsoft.OperationalInsights/workspaces/law-monitoring-demo\"],\"visualization\":\"stat\",\"statSettings\":{\"valueField\":\"Status\",\"valueAggregation\":\"None\",\"valueTooltipSettings\":{\"tooltip\":\"Status\"},\"colorSettings\":{\"type\":\"thresholds\",\"mode\":\"background\",\"heatmapPalette\":\"greenRed\",\"thresholdsGrid\":[{\"sourceColumn\":\"Status\",\"operator\":\"contains\",\"thresholdValue\":\"Healthy\",\"representation\":\"green\"},{\"sourceColumn\":\"Status\",\"operator\":\"contains\",\"thresholdValue\":\"Critical\",\"representation\":\"redBright\"}]},\"iconSettings\":{\"thresholdsGrid\":[{\"sourceColumn\":\"Status\",\"operator\":\"contains\",\"thresholdValue\":\"Healthy\",\"representation\":\"success\"},{\"operator\":\"contains\",\"thresholdValue\":\"Critical\",\"representation\":\"4\"}]},\"tagText\":\"\",\"valueFontStyle\":\"large\"}},\"name\":\"query - 3 - Copy\"}],\"isLocked\":false,\"fallbackResourceIds\":[\"azure monitor\"]}",
        "version": "1.0",
        "sourceId": "[parameters('workbookSourceId')]",
        "category": "[parameters('workbookType')]"
      }
    }
  ],
  "outputs": {
    "workbookId": {
      "type": "string",
      "value": "[resourceId( 'microsoft.insights/workbooks', parameters('workbookId'))]"
    }
  },
  "$schema": "http://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#"
}