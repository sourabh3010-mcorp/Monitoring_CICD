DASHBOARD DEPLOYMENT terraform

locals {
  dashboard_files = var.dashboard_files
}

resource "azapi_resource" "dashboards" {
  for_each = { for f in local.dashboard_files : basename(f) => f }

  type      = "Microsoft.Portal/dashboards@2022-06-01-preview"
  name      = "${var.environment}-dashboard-${replace(each.key, ".json", "")}"
  parent_id = azurerm_resource_group.rg.id
  location  = var.location

  # Disable schema validation to allow newer API versions
  schema_validation_enabled = false

  # Remove 'location' key safely
  body = jsonencode(
    { for k, v in jsondecode(file("${path.module}/../dashboard/${each.value}")) : 
        k => v if k != "location"
    }
  )
}



workbook

locals {
  workbook_files = var.workbook_files
}



resource "azurerm_resource_group_template_deployment" "workbooks" {
  for_each = {
    for f in var.workbook_files :
    f => f
  }

  name                = "${var.environment}-workbook-${replace(each.key, ".json", "")}"
  resource_group_name = var.resource_group_name
  deployment_mode     = "Incremental"

  template_content = file(
    "${path.module}/../workbooks/${lower(var.environment)}/${each.value}"
  )

  parameters_content = jsonencode({
    workbookId = {
      value = var.workbook_id[each.key]
    }
    workbookDisplayName = {
      value = "Health score ${upper(var.environment)}"
    }
    workbookType = {
      value = "workbook"
    }
    workbookSourceId = {
      value = "azure monitor"
    }
  })
}