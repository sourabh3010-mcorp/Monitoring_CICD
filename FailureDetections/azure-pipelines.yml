trigger:
  branches:
    include:
      - main

name: Monitoring-$(Date:yyyyMMdd).$(Rev:r)

variables:
  terraformVersion: '1.7.5'
  tfWorkingDir: 'FailureDetections/terraform'

stages:

# =========================================================
# BUILD STAGE
# =========================================================
- stage: Build
  displayName: "Build & Terraform Plan"
  jobs:
  - job: Build
    pool:
      vmImage: ubuntu-latest

    steps:
    - checkout: self

    - task: Bash@3
      displayName: "Install Terraform"
      inputs:
        targetType: inline
        script: |
          wget https://releases.hashicorp.com/terraform/$(terraformVersion)/terraform_$(terraformVersion)_linux_amd64.zip
          unzip terraform_$(terraformVersion)_linux_amd64.zip
          sudo mv terraform /usr/local/bin/
          terraform -version

    - task: AzureCLI@2
      displayName: "Terraform Init & Plan (QA)"
      inputs:
        azureSubscription: 'VS Professional Subscription-Nitin Pradhan'
        scriptType: bash
        scriptLocation: inlineScript
        inlineScript: |
          set -e
          cd $(tfWorkingDir)

          terraform init \
            -backend-config="resource_group_name=tfstate-rg-monitoring" \
            -backend-config="storage_account_name=tfstatestoracct02" \
            -backend-config="container_name=tfstate" \
            -backend-config="key=qa.tfstate"

          terraform validate
          terraform plan -var-file="qa.tfvars" -out=qa.tfplan

    - publish: $(tfWorkingDir)
      artifact: terraform-plans


# =========================================================
# DEPLOY TO QA
# =========================================================
- stage: Deploy_QA
  displayName: "Deploy to QA"
  dependsOn: Build
  jobs:
  - deployment: QA
    strategy:
      runOnce:
        deploy:
          steps:
          - download: current
            artifact: terraform-plans

          - task: AzureCLI@2
            displayName: "Terraform Apply QA"
            inputs:
              azureSubscription: 'VS Professional Subscription-Nitin Pradhan'
              scriptType: bash
              scriptLocation: inlineScript
              inlineScript: |
                set -e
                cd terraform-plans

                export ARM_USE_AZURECLI_AUTH=true
                terraform apply -auto-approve qa.tfplan


# =========================================================
# DEPLOY TO PROD (MANUAL APPROVAL)
# =========================================================
- stage: Deploy_Prod
  displayName: "Deploy to PROD"
  dependsOn: Deploy_QA
  condition: succeeded()
  jobs:
  - deployment: PROD   # <-- Add approval in Azure DevOps UI
    strategy:
      runOnce:
        deploy:
          steps:
          - download: current
            artifact: terraform-plans

          - task: AzureCLI@2
            displayName: "Terraform Plan PROD"
            inputs:
              azureSubscription: 'VS Professional Subscription-Nitin Pradhan'
              scriptType: bash
              scriptLocation: inlineScript
              inlineScript: |
                set -e
                cd terraform-plans

                terraform init -reconfigure \
                  -backend-config="key=prod.tfstate"

                terraform plan -var-file="prod.tfvars" -out=prod.tfplan

          - task: AzureCLI@2
            displayName: "Terraform Apply PROD"
            inputs:
              azureSubscription: 'VS Professional Subscription-Nitin Pradhan'
              scriptType: bash
              scriptLocation: inlineScript
              inlineScript: |
                set -e
                cd terraform-plans
                terraform apply -auto-approve prod.tfplan


# =========================================================
# ROLLBACK STAGE (OPTIONAL / MANUAL)
# =========================================================
- stage: Rollback
  displayName: "Rollback Deployment"
  dependsOn: Deploy_Prod
  condition: failed()
  jobs:
  - job: Rollback
    pool:
      vmImage: ubuntu-latest
    steps:
    - script: |
        echo "Rollback triggered."
        echo "Re-apply previous known-good state or redeploy last successful build."
        echo "Rollback strategy:"
        echo "1. Checkout previous commit"
        echo "2. terraform apply saved plan"
      displayName: "Rollback Instructions"
