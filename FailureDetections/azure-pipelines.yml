trigger:
  branches:
    include:
      - main

pool:
  vmImage: ubuntu-latest

parameters:
  - name: environment
    displayName: "Environment"
    type: string
    default: "qa"
    values:
      - qa
      - prod

variables:
  environment: ${{ parameters.environment }}

stages:
  # ======================================================
  # Stage 1: Build
  # ======================================================
  - stage: Build
    displayName: "Build Terraform Artifact"
    jobs:
      - job: BuildJob
        steps:
          - checkout: self

          # Install Terraform (same as your current pipeline)
          - script: |
              sudo apt-get update -y
              wget -qO- https://aka.ms/InstallAzureCLIDeb | sudo bash
              sudo apt-get install -y wget unzip
              wget https://releases.hashicorp.com/terraform/1.7.5/terraform_1.7.5_linux_amd64.zip
              unzip -o terraform_1.7.5_linux_amd64.zip
              sudo mv -f terraform /usr/local/bin/
              terraform -version
            displayName: "Install Terraform 1.7.5"

          # Validate Terraform

          # Package Terraform code as artifact (for rollback)
          - task: PublishBuildArtifacts@1
            inputs:
              PathtoPublish: 'FailureDetections/'
              ArtifactName: 'terraform-code'
              publishLocation: 'Container'
            displayName: "Publish Terraform Artifact"

  # ======================================================
  # Stage 2: Release (Deploy)
  # ======================================================
  - stage: Release
    displayName: "Deploy Terraform"
    dependsOn: Build
    jobs:
      - job: DeployJob
        steps:
          - checkout: self

          # Download artifact from Build stage
          - task: DownloadBuildArtifacts@0
            inputs:
              buildType: 'current'
              downloadType: 'single'
              artifactName: 'terraform-code'
              downloadPath: '$(Pipeline.Workspace)'

          # Terraform Init
          - script: |
              cd "$(Pipeline.Workspace)/terraform-code"
              terraform init -upgrade \
                -backend-config="resource_group_name=tfstate-rg-monitoring" \
                -backend-config="storage_account_name=tfstatestoracct02" \
                -backend-config="container_name=tfstate" \
                -backend-config="key=$(environment).tfstate"
            displayName: "Terraform Init"
            env:
              ARM_CLIENT_ID: $(TF_CLIENT_ID)
              ARM_CLIENT_SECRET: $(TF_CLIENT_SECRET)
              ARM_TENANT_ID: $(TF_TENANT_ID)
              ARM_SUBSCRIPTION_ID: $(TF_SUBSCRIPTION_ID)

          # Terraform Plan
          - task: AzureCLI@2
            displayName: "Terraform Plan"
            inputs:
              azureSubscription: 'VS Professional Subscription-Nitin Pradhan'
              scriptType: bash
              scriptLocation: inlineScript
              inlineScript: |
                cd "$(Pipeline.Workspace)/terraform-code"
                ENV="${environment:-qa}"
                terraform plan -var-file="${ENV}.tfvars" -out=tfplan -input=false

          # Terraform Apply
          - task: AzureCLI@2
            displayName: "Terraform Apply"
            inputs:
              azureSubscription: 'VS Professional Subscription-Nitin Pradhan'
              scriptType: bash
              scriptLocation: inlineScript
              inlineScript: |
                cd "$(Pipeline.Workspace)/terraform-code"
                if [ -f tfplan ]; then
                  terraform apply -input=false -auto-approve tfplan
                else
                  echo "ERROR: tfplan not found, aborting."
                  exit 1
                fi
