trigger:
  branches:
    include:
      - main

pool:
  vmImage: ubuntu-latest

parameters:
  - name: environment
    displayName: "Environment"
    type: string
    default: "qa"
    values:
      - qa
      - prod

variables:
  environment: ${{ parameters.environment }}

steps:
  - checkout: self

  # Install Terraform
  - script: |
      sudo apt-get update -y
      sudo apt-get install -y wget unzip
      wget https://releases.hashicorp.com/terraform/1.7.5/terraform_1.7.5_linux_amd64.zip
      unzip terraform_1.7.5_linux_amd64.zip
      sudo mv terraform /usr/local/bin/
      terraform -version
    displayName: "Install Terraform 1.7.5"

  # Login to Azure using Service Connection and run Terraform init using Azure CLI auth
  - task: AzureCLI@2
    displayName: "Azure Login and Terraform Init (use AZ CLI auth for Terraform)"
    inputs:
      azureSubscription: "VS Professional Subscription-Nitin Pradhan"
      scriptType: bash
      scriptLocation: inlineScript
      inlineScript: |
        echo "Azure Login Successful"
        az account show

        echo "Running terraform init using Azure CLI authentication (no ARM_CLIENT_* required)..."

        # Make Terraform use the Azure CLI credential that this task logged in with
        export ARM_USE_AZURECLI_AUTH=true

        cd FailureDetections/terraform

        terraform init \
          -backend-config="resource_group_name=tfstate-rg-monitoring" \
          -backend-config="storage_account_name=tfstatestoracct02" \
          -backend-config="container_name=tfstate" \
          -backend-config="key=$(environment).tfstate"

    env:
      # It's OK to leave these empty; we rely on the Azure CLI auth instead.
      # If you later switch to client-id/secret method, provide ARM_CLIENT_ID/ARM_CLIENT_SECRET here.
      ARM_USE_AZURECLI_AUTH: "true"

  # (Subsequent Terraform steps can be added here; run them inside AzureCLI tasks or create a service principal stored as secure variables)