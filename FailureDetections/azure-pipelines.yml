trigger:
  branches:
    include:
      - main

pool:
  vmImage: ubuntu-latest

parameters:
  - name: environment
    displayName: "Environment"
    type: string
    default: "qa"
    values:
      - qa
      - prod

variables:
  environment: ${{ parameters.environment }}

stages:
  # ======================================================
  # Stage 1: Build
  # ======================================================
  - stage: Build
    displayName: "Build Terraform Artifact"
    jobs:
      - job: BuildJob
        steps:
          - checkout: self

          # Install Terraform (same as your current pipeline)
          - script: |
              sudo apt-get update -y
              wget -qO- https://aka.ms/InstallAzureCLIDeb | sudo bash
              sudo apt-get install -y wget unzip
              wget https://releases.hashicorp.com/terraform/1.7.5/terraform_1.7.5_linux_amd64.zip
              unzip -o terraform_1.7.5_linux_amd64.zip
              sudo mv -f terraform /usr/local/bin/
              terraform -version
            displayName: "Install Terraform 1.7.5"

          # Validate Terraform

          - script: |
              CUSTOM_ID="TF-$(date +%Y%m%d%H%M%S)"
              echo "Generated Build ID: $CUSTOM_ID"
              echo "##vso[task.setvariable variable=CUSTOM_BUILD_ID]$CUSTOM_ID"
            displayName: "Generate Custom Build ID"

          - script: |
              echo "Build ID: $(CUSTOM_BUILD_ID)" > FailureDetections/build_id.txt
            displayName: "Write Build ID to file"

          - task: PublishBuildArtifacts@1
            inputs:
              PathtoPublish: 'FailureDetections/'
              ArtifactName: 'umd-code-$(CUSTOM_BUILD_ID)'
              publishLocation: 'Container'
            displayName: "Publish Terraform Artifact with ID"


  # ======================================================
  # Stage 2: Release (Deploy)
  # ======================================================
  - stage: Release
    displayName: "Deploy Terraform"
    dependsOn: Build
    jobs:
      - job: DeployJob
        steps:
          - checkout: self

          # Download artifact from Build stage
          - task: DownloadBuildArtifacts@0
            inputs:
              buildType: 'current'
              downloadType: 'single'
              artifactName: 'umd-code-$(CUSTOM_BUILD_ID)'
              downloadPath: '$(Pipeline.Workspace)'
            displayName: "Download Terraform Artifact"


          # Terraform Init
          - script: |
              echo "Initializing Terraform backend for environment: $(environment)"
              terraform init -upgrade \
                -backend-config="resource_group_name=tfstate-rg-monitoring" \
                -backend-config="storage_account_name=tfstatestoracct02" \
                -backend-config="container_name=tfstate" \
                -backend-config="key=$(environment).tfstate" \
                -backend-config="access_key=WfJKRgecjuhKEpFCrU3xkF8Dd1kFgKGFR6ygi5ApP8O+XsAgqsFX4KVp1AXQSAohg9DDXOw7zZmz+ASt+YzJTw=="
            workingDirectory: FailureDetections/terraform
            displayName: "Terraform Init"
            env:
              ARM_CLIENT_ID: $(TF_CLIENT_ID)
              ARM_CLIENT_SECRET: $(TF_CLIENT_SECRET)
              ARM_TENANT_ID: $(TF_TENANT_ID)
              ARM_SUBSCRIPTION_ID: $(TF_SUBSCRIPTION_ID)

          # ======================================================
          # Terraform Validate
          # ======================================================
          - script: terraform validate
            workingDirectory: FailureDetections/terraform
            displayName: "Terraform Validate"
            env:
              ARM_CLIENT_ID: $(TF_CLIENT_ID)
              ARM_CLIENT_SECRET: $(TF_CLIENT_SECRET)
              ARM_TENANT_ID: $(TF_TENANT_ID)
              ARM_SUBSCRIPTION_ID: $(TF_SUBSCRIPTION_ID)
         
          - script: |
              set -euo pipefail
              echo "Agent sources directory: $(Build.SourcesDirectory)"
              echo "Listing repo root:"
              ls -la "$(Build.SourcesDirectory)" || true

              echo
              echo "Looking for FailureDetections directory (case-sensitive):"
              if [ -d "$(Build.SourcesDirectory)/FailureDetections" ]; then
                echo "Found FailureDetections:"
                ls -la "$(Build.SourcesDirectory)/FailureDetections" || true
              else
                echo "FailureDetections directory NOT found at: $(Build.SourcesDirectory)/FailureDetections"
              fi

              echo
              echo "Searching for Terraform files in the repo (shows paths of committed .tf files and .tfvars):"
              cd "$(Build.SourcesDirectory)"
              git ls-files
              git ls-files | grep '\.tf$' || echo "No .tf files found in repo (git ls-files returned nothing)."
              git ls-files | grep '\.tfvars$' || echo "No .tfvars files found in repo (git ls-files returned nothing)."

              echo
              echo "If the terraform files are located at a different path, update your workingDirectory or `cd` to the correct folder."
            displayName: "Debug: list repo and find Terraform files"
          # ======================================================
          # Debug listing (optional, keeps as you had)
          # ======================================================
          # Terraform Plan
          - task: AzureCLI@2
            displayName: "Terraform Plan"
            inputs:
              azureSubscription: 'VS Professional Subscription-Nitin Pradhan'
              scriptType: bash
              scriptLocation: inlineScript
              inlineScript: |
                cd "$(Pipeline.Workspace)/terraform-code"
                ENV="${environment:-qa}"
                terraform plan -var-file="${ENV}.tfvars" -out=tfplan -input=false

          # Terraform Apply
          - task: AzureCLI@2
            displayName: "Terraform Apply"
            inputs:
              azureSubscription: 'VS Professional Subscription-Nitin Pradhan'
              scriptType: bash
              scriptLocation: inlineScript
              inlineScript: |
                cd "$(Pipeline.Workspace)/terraform-code"
                if [ -f tfplan ]; then
                  terraform apply -input=false -auto-approve tfplan
                else
                  echo "ERROR: tfplan not found, aborting."
                  exit 1
                fi
