trigger:
  branches:
    include:
      - main

pool:
  vmImage: ubuntu-latest

parameters:
  - name: environment
    displayName: "Environment"
    type: string
    default: "qa"
    values:
      - qa
      - prod

variables:
  environment: ${{ parameters.environment }}
  # Ensure the following secure variables exist in the pipeline or variable group:
  # TF_CLIENT_ID (secret), TF_CLIENT_SECRET (secret), TF_TENANT_ID (secret), TF_SUBSCRIPTION_ID (secret)

steps:
  - checkout: self

  # ======================================================
  # Install Terraform 1.7.5
  # ======================================================
  - script: |
      sudo apt-get update -y
      wget -qO- https://aka.ms/InstallAzureCLIDeb | sudo bash
      sudo apt-get install -y wget unzip
      wget https://releases.hashicorp.com/terraform/1.7.5/terraform_1.7.5_linux_amd64.zip
      unzip terraform_1.7.5_linux_amd64.zip
      sudo mv terraform /usr/local/bin/
      terraform -version
    displayName: "Install Terraform 1.7.5"

  # ======================================================
  # Export SP credentials as ARM_* environment variables for Terraform
  # ======================================================
  - script: |
      echo "Exporting Service Principal credentials as ARM_* env variables"
      echo "ARM_CLIENT_ID: $(TF_CLIENT_ID)"
      echo "ARM_CLIENT_SECRET: [hidden]"
      echo "ARM_TENANT_ID: $(TF_TENANT_ID)"
      echo "ARM_SUBSCRIPTION_ID: $(TF_SUBSCRIPTION_ID)"
    displayName: "Set ARM_* environment variables for Terraform"

  # ======================================================
  # Terraform Init
  # ======================================================
  - script: |
      echo "Initializing Terraform backend for environment: $(environment)"
      terraform init -upgrade \
        -backend-config="resource_group_name=tfstate-rg-monitoring" \
        -backend-config="storage_account_name=tfstatestoracct02" \
        -backend-config="container_name=tfstate" \
        -backend-config="key=$(environment).tfstate" \
        -backend-config="access_key=WfJKRgecjuhKEpFCrU3xkF8Dd1kFgKGFR6ygi5ApP8O+XsAgqsFX4KVp1AXQSAohg9DDXOw7zZmz+ASt+YzJTw=="
    
    workingDirectory: FailureDetections/terraform
    displayName: "Terraform Init"
    env:
      ARM_CLIENT_ID: $(TF_CLIENT_ID)
      ARM_CLIENT_SECRET: $(TF_CLIENT_SECRET)
      ARM_TENANT_ID: $(TF_TENANT_ID)
      ARM_SUBSCRIPTION_ID: $(TF_SUBSCRIPTION_ID)

  # ======================================================
  # Terraform Validate
  # ======================================================
  - script: terraform validate
    workingDirectory: FailureDetections/terraform
    displayName: "Terraform Validate"
    env:
      ARM_CLIENT_ID: $(TF_CLIENT_ID)
      ARM_CLIENT_SECRET: $(TF_CLIENT_SECRET)
      ARM_TENANT_ID: $(TF_TENANT_ID)
      ARM_SUBSCRIPTION_ID: $(TF_SUBSCRIPTION_ID)

  
  # ======================================================
  # Terraform Plan
  # ======================================================

  - script: |
      export ARM_CLIENT_ID="${TF_CLIENT_ID}"
      export ARM_CLIENT_SECRET="${TF_CLIENT_SECRET}"
      export ARM_TENANT_ID="${TF_TENANT_ID}"
      export ARM_SUBSCRIPTION_ID="${TF_SUBSCRIPTION_ID}"
      terraform plan -var-file="/FailureDetections/terraform/qa.tfvars"
    workingDirectory: FailureDetections/terraform
    displayName: "Terraform Plan"


  # - script: |
  #     set -euo pipefail
  #     echo "=== Terraform Plan: verify environment and tfvars path ==="

  #     TF_WORKDIR="$(Build.SourcesDirectory)/FailureDetections/terraform"
  #     echo "Agent sources directory: $(Build.SourcesDirectory)"
  #     echo "Terraform working dir: $TF_WORKDIR"

  #     if [ ! -d "$TF_WORKDIR" ]; then
  #       echo "ERROR: Terraform working directory not found: $TF_WORKDIR"
  #       ls -la "$(Build.SourcesDirectory)" || true
  #       exit 1
  #     fi

  #     cd "$TF_WORKDIR"

  #     # Show both compile-time parameter and runtime variable (for debug)
  #     echo "Compile-time parameter.environment = '${{ parameters.environment }}'"
  #     echo "Runtime variable (expanded in script) environment = '${environment:-<not-set>}'"

  #     ENV="${environment:-${{ parameters.environment }}}"
  #     if [ -z "$ENV" ]; then
  #       echo "ERROR: environment is empty. Provide the environment parameter (qa or prod)."
  #       exit 1
  #     fi
  #     echo "Using environment: $ENV"

  #     TFVARS_FILE="${ENV}.tfvars"
  #     echo "Expecting var-file at: $TFVARS_FILE"

  #     if [ ! -f "$TFVARS_FILE" ]; then
  #       echo "ERROR: Variables file not found: $TFVARS_FILE"
  #       echo "Contents of terraform folder:"
  #       ls -la || true
  #       exit 1
  #     fi


  #     echo "Running terraform plan and saving to tfplan..."
  #     terraform plan -var-file="$TFVARS_FILE" -out=tfplan -input=false
  #   displayName: "Terraform Plan (validate env & tfvars, produce tfplan)"
  #   env:
  #     # ensure runtime variable is present in the script
  #     environment: ${{ parameters.environment }}

