trigger:
  branches:
    include:
      - main

pool:
  vmImage: ubuntu-latest

parameters:
  - name: environment
    displayName: "Environment"
    type: string
    default: "qa"
    values:
      - qa
      - prod

variables:
  environment: ${{ parameters.environment }}
  # Ensure the following secure variables exist in the pipeline or variable group:
  # TF_CLIENT_ID (secret), TF_CLIENT_SECRET (secret), TF_TENANT_ID (secret), TF_SUBSCRIPTION_ID (secret)

steps:
  - checkout: self

  # ======================================================
  # Install Terraform 1.7.5
  # ======================================================
  - script: |
      sudo apt-get update -y
      wget -qO- https://aka.ms/InstallAzureCLIDeb | sudo bash
      sudo apt-get install -y wget unzip
      wget https://releases.hashicorp.com/terraform/1.7.5/terraform_1.7.5_linux_amd64.zip
      unzip terraform_1.7.5_linux_amd64.zip
      sudo mv terraform /usr/local/bin/
      terraform -version
    displayName: "Install Terraform 1.7.5"

  # ======================================================
  # Export SP credentials as ARM_* environment variables for Terraform
  # ======================================================
  - script: |
      echo "Exporting Service Principal credentials as ARM_* env variables"
      echo "ARM_CLIENT_ID: $(TF_CLIENT_ID)"
      echo "ARM_CLIENT_SECRET: [hidden]"
      echo "ARM_TENANT_ID: $(TF_TENANT_ID)"
      echo "ARM_SUBSCRIPTION_ID: $(TF_SUBSCRIPTION_ID)"
    displayName: "Set ARM_* environment variables for Terraform"

  # ======================================================
  # Terraform Init
  # ======================================================
  - script: |
      echo "Initializing Terraform backend for environment: $(environment)"
      terraform init -upgrade \
        -backend-config="resource_group_name=tfstate-rg-monitoring" \
        -backend-config="storage_account_name=tfstatestoracct02" \
        -backend-config="container_name=tfstate" \
        -backend-config="key=$(environment).tfstate" \
        -backend-config="access_key=WfJKRgecjuhKEpFCrU3xkF8Dd1kFgKGFR6ygi5ApP8O+XsAgqsFX4KVp1AXQSAohg9DDXOw7zZmz+ASt+YzJTw=="
    
    workingDirectory: FailureDetections/terraform
    displayName: "Terraform Init"
    env:
      ARM_CLIENT_ID: $(TF_CLIENT_ID)
      ARM_CLIENT_SECRET: $(TF_CLIENT_SECRET)
      ARM_TENANT_ID: $(TF_TENANT_ID)
      ARM_SUBSCRIPTION_ID: $(TF_SUBSCRIPTION_ID)

  # ======================================================
  # Terraform Validate
  # ======================================================
  # - script: terraform validate
  #   workingDirectory: FailureDetections/terraform
  #   displayName: "Terraform Validate"
  #   env:
  #     ARM_CLIENT_ID: $(TF_CLIENT_ID)
  #     ARM_CLIENT_SECRET: $(TF_CLIENT_SECRET)
  #     ARM_TENANT_ID: $(TF_TENANT_ID)
  #     ARM_SUBSCRIPTION_ID: $(TF_SUBSCRIPTION_ID)

  - script: |
      set -euo pipefail
      echo "Agent sources directory: $(Build.SourcesDirectory)"
      echo "Listing repo root:"
      ls -la "$(Build.SourcesDirectory)" || true

      echo
      echo "Looking for FailureDetections directory (case-sensitive):"
      if [ -d "$(Build.SourcesDirectory)/FailureDetections" ]; then
        echo "Found FailureDetections:"
        ls -la "$(Build.SourcesDirectory)/FailureDetections" || true
      else
        echo "FailureDetections directory NOT found at: $(Build.SourcesDirectory)/FailureDetections"
      fi

      echo
      echo "Searching for Terraform files in the repo (shows paths of committed .tf files):"
      cd "$(Build.SourcesDirectory)"
      git ls-files | grep '\.tf$' || echo "No .tf files found in repo (git ls-files returned nothing)."
      git ls-files | grep '\.tfvars$' || echo "No .tfvars files found in repo (git ls-files returned nothing)."

      echo
      echo "If the terraform files are located at a different path, update your workingDirectory or `cd` to the correct folder."
    displayName: "Debug: list repo and find Terraform files"

  # ======================================================
  # Terraform Plan
  # ======================================================

  # - script: |
  #     export ARM_CLIENT_ID="${TF_CLIENT_ID}"
  #     export ARM_CLIENT_SECRET="${TF_CLIENT_SECRET}"
  #     export ARM_TENANT_ID="${TF_TENANT_ID}"
  #     export ARM_SUBSCRIPTION_ID="${TF_SUBSCRIPTION_ID}"
  #     terraform plan -var-file="/FailureDetections/terraform/${environment}.tfvars"
  #   workingDirectory: FailureDetections/terraform
  #   displayName: "Terraform Plan"


# Replace your existing Plan and Apply steps with the two steps below.
# Plan step: validates env & tfvars, runs terraform init/validate/plan -out=tfplan
  # - script: |
  #     set -euo pipefail
  #     TF_WORKDIR="FailureDetections/terraform"
  #     echo "Working directory: $TF_WORKDIR"
  #     cd "$TF_WORKDIR" || { echo "ERROR: working directory not found: $TF_WORKDIR"; exit 1; }

  #     # Ensure pipeline provided environment
  #     ENV="${environment:-}"
  #     if [ -z "$ENV" ]; then
  #       echo "ERROR: pipeline variable 'environment' is empty. Provide the environment parameter (e.g. qa or prod)."
  #       echo "Current parameters/variables:"
  #       echo "  parameters.environment = ${{ parameters.environment }}"
  #       echo "  variables.environment  = ${environment:-<not-set>}"
  #       exit 1
  #     fi

  #     TFVARS_FILE="environment/${ENV}.tfvars"
  #     echo "Using var-file: $TFVARS_FILE"

  #     if [ ! -f "$TFVARS_FILE" ]; then
  #       echo "ERROR: Variables file not found: $TFVARS_FILE"
  #       echo "Contents of environment/ directory:"
  #       ls -la environment || true
  #       echo ""
  #       echo "Ensure you have a file named 'environment/${ENV}.tfvars' in FailureDetections/terraform."
  #       exit 1
  #     fi

  #     echo "Listing files in Terraform folder:"
  #     ls -la

  #     echo "Initializing Terraform..."
  #     terraform init -input=false

  #     echo "Validating Terraform configuration..."
  #     terraform validate

  #     echo "Running terraform plan and saving to tfplan..."
  #     terraform plan -var-file="$TFVARS_FILE" -out=tfplan -input=false
  #   displayName: "Terraform Plan (validate env & tfvars, produce tfplan)"
  #   workingDirectory: FailureDetections/terraform
  #   env:
  #     # map pipeline parameter into the script
  #     environment: $(environment)

  # # Apply step: apply the saved plan (tfplan) if present, otherwise fail (explicit is safer)
  # - script: |
  #     set -euo pipefail
  #     TF_WORKDIR="FailureDetections/terraform"
  #     cd "$TF_WORKDIR" || { echo "ERROR: working directory not found: $TF_WORKDIR"; exit 1; }

  #     ENV="${environment:-}"
  #     if [ -z "$ENV" ]; then
  #       echo "ERROR: pipeline variable 'environment' is empty. Aborting apply."
  #       exit 1
  #     fi

  #     if [ -f tfplan ]; then
  #       echo "Applying saved plan file tfplan..."
  #       terraform apply -input=false -auto-approve tfplan
  #     else
  #       echo "ERROR: No saved plan file found (tfplan). Aborting apply to avoid drifting from what was planned."
  #       echo "If you want to apply directly without a saved plan, update this step to pass -var-file=\"environment/${ENV}.tfvars\" explicitly."
  #       exit 1
  #     fi
  #   displayName: "Terraform Apply (apply saved plan)"
  #   workingDirectory: FailureDetections/terraform
  #   env:
  #     environment: $(environment)

  # - script: terraform plan -var-file="environment/$(environment).tfvars"
  #   workingDirectory: FailureDetections/terraform
  #   displayName: "Terraform Plan"
  #   env:
  #     ARM_CLIENT_ID: $(TF_CLIENT_ID)
  #     ARM_CLIENT_SECRET: $(TF_CLIENT_SECRET)
  #     ARM_TENANT_ID: $(TF_TENANT_ID)
  #     ARM_SUBSCRIPTION_ID: $(TF_SUBSCRIPTION_ID)


  # - task: TerraformCLI@0
  #   displayName: 'Terraform Plan'
  #   inputs:
  #     command: 'plan'
  #     workingDirectory: 'FailureDetections/terraform/'
  #     environmentServiceName: 'VS Professional Subscription-Nitin Pradhan'  # Replace with your service connection name
  #     commandOptions: '-var-file="environment/$(environment).tfvars'



  # ======================================================
  # Terraform Apply (changed)
  # ======================================================
  # - script: |
  #     echo "Running terraform apply for environment: $(environment)"
  #     # Run apply non-interactively; use same var-file as plan. Remove -auto-approve if you require manual approval.
  #     terraform apply -var-file="environment/$(environment).tfvars" -input=false -auto-approve
  #   workingDirectory: FailureDetections/terraform
  #   displayName: "Terraform Apply"
  #   env:
  #     ARM_CLIENT_ID: $(TF_CLIENT_ID)
  #     ARM_CLIENT_SECRET: $(TF_CLIENT_SECRET)
  #     ARM_TENANT_ID: $(TF_TENANT_ID)
  #     ARM_SUBSCRIPTION_ID: $(TF_SUBSCRIPTION_ID)