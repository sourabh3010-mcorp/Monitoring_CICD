trigger:
  branches:
    include:
      - main

name: Monitoring-$(Date:yyyyMMdd).$(Rev:r)

variables:
  terraformVersion: '1.7.5'
  tfWorkingDir: 'FailureDetections/terraform'

stages:

# =========================================================
# BUILD STAGE (INIT + PLAN QA)
# =========================================================
- stage: Build
  displayName: "Build & Terraform Plan"
  jobs:
  - job: Build
    displayName: "Terraform Build"
    pool:
      vmImage: ubuntu-latest

    steps:
    - checkout: self

    - task: Bash@3
      displayName: "Install Terraform"
      inputs:
        targetType: inline
        script: |
          wget https://releases.hashicorp.com/terraform/$(terraformVersion)/terraform_$(terraformVersion)_linux_amd64.zip
          unzip terraform_$(terraformVersion)_linux_amd64.zip
          sudo mv terraform /usr/local/bin/
          terraform -version

    - task: AzureCLI@2
      displayName: "Terraform Init & Plan (QA)"
      inputs:
        azureSubscription: 'VS Professional Subscription-Nitin Pradhan'
        scriptType: bash
        scriptLocation: inlineScript
        inlineScript: |
          set -e
          cd $(tfWorkingDir)

          # ---- Service Principal auth for Terraform ----
          export ARM_CLIENT_ID=$servicePrincipalId
          export ARM_CLIENT_SECRET=$servicePrincipalKey
          export ARM_TENANT_ID=$tenantId
          export ARM_SUBSCRIPTION_ID=$subscriptionId

          terraform init \
            -backend-config="resource_group_name=tfstate-rg-monitoring" \
            -backend-config="storage_account_name=tfstatestoracct02" \
            -backend-config="container_name=tfstate" \
            -backend-config="key=qa.tfstate"

          terraform validate
          terraform plan -var-file="qa.tfvars" -out=qa.tfplan

    - publish: $(tfWorkingDir)
      artifact: terraform-plans

# =========================================================
# DEPLOY TO QA
# =========================================================
- stage: Deploy_QA
  displayName: "Deploy to QA"
  dependsOn: Build
  jobs:
  - job: QA
    displayName: "Terraform Apply QA"
    pool:
      vmImage: ubuntu-latest

    steps:
    - download: current
      artifact: terraform-plans

    - task: AzureCLI@2
      displayName: "Apply QA"
      inputs:
        azureSubscription: 'VS Professional Subscription-Nitin Pradhan'
        scriptType: bash
        scriptLocation: inlineScript
        inlineScript: |
          set -e
          cd terraform-plans

          export ARM_CLIENT_ID=$servicePrincipalId
          export ARM_CLIENT_SECRET=$servicePrincipalKey
          export ARM_TENANT_ID=$tenantId
          export ARM_SUBSCRIPTION_ID=$subscriptionId

          terraform apply -auto-approve qa.tfplan

# =========================================================
# DEPLOY TO PROD
# =========================================================
- stage: Deploy_Prod
  displayName: "Deploy to PROD"
  dependsOn: Deploy_QA
  condition: succeeded()
  jobs:
  - job: PROD
    displayName: "Terraform Apply PROD"
    pool:
      vmImage: ubuntu-latest

    steps:
    - download: current
      artifact: terraform-plans

    - task: AzureCLI@2
      displayName: "Terraform Init & Plan PROD"
      inputs:
        azureSubscription: 'VS Professional Subscription-Nitin Pradhan'
        scriptType: bash
        scriptLocation: inlineScript
        inlineScript: |
          set -e
          cd terraform-plans

          export ARM_CLIENT_ID=$servicePrincipalId
          export ARM_CLIENT_SECRET=$servicePrincipalKey
          export ARM_TENANT_ID=$tenantId
          export ARM_SUBSCRIPTION_ID=$subscriptionId

          terraform init -reconfigure \
            -backend-config="key=prod.tfstate"

          terraform plan -var-file="prod.tfvars" -out=prod.tfplan

    - task: AzureCLI@2
      displayName: "Apply PROD"
      inputs:
        azureSubscription: 'VS Professional Subscription-Nitin Pradhan'
        scriptType: bash
        scriptLocation: inlineScript
        inlineScript: |
          set -e
          cd terraform-plans

          export ARM
