trigger:
  branches:
    include:
      - main

pool:
  vmImage: ubuntu-latest

parameters:
  - name: environment
    displayName: "Environment"
    type: string
    default: "qa"
    values:
      - qa
      - prod

variables:
  environment: ${{ parameters.environment }}

steps:
  - checkout: self

  # ======================================================
  # Install Terraform (Manual installation = no ENOENT issue)
  # ======================================================
  - script: |
      sudo apt-get update -y
      sudo apt-get install -y wget unzip
      wget https://releases.hashicorp.com/terraform/1.7.5/terraform_1.7.5_linux_amd64.zip
      unzip terraform_1.7.5_linux_amd64.zip
      sudo mv terraform /usr/local/bin/
      terraform -version
    displayName: "Install Terraform 1.7.5"

  # ======================================================
  # Azure Login (Service Connection) + Export ARM_* env vars
  # ======================================================
  - task: AzureCLI@2
    displayName: "Azure Login + Export ARM Variables"
    inputs:
      azureSubscription: "Visual Studio Professional Subscription-LS"
      scriptType: bash
      scriptLocation: inlineScript
      inlineScript: |
        echo "Getting Azure authentication details..."

        export ARM_SUBSCRIPTION_ID=$(az account show --query id -o tsv)
        export ARM_TENANT_ID=$(az account show --query tenantId -o tsv)

        # Service connection injects SP automatically
        export ARM_CLIENT_ID=$servicePrincipalId
        export ARM_CLIENT_SECRET=$servicePrincipalKey

        # Print subscription for debugging (safe)
        echo "Authenticated into subscription: $ARM_SUBSCRIPTION_ID"

        # Persist env vars for next tasks
        echo "##vso[task.setvariable variable=ARM_CLIENT_ID]$ARM_CLIENT_ID"
        echo "##vso[task.setvariable variable=ARM_CLIENT_SECRET]$ARM_CLIENT_SECRET"
        echo "##vso[task.setvariable variable=ARM_TENANT_ID]$ARM_TENANT_ID"
        echo "##vso[task.setvariable variable=ARM_SUBSCRIPTION_ID]$ARM_SUBSCRIPTION_ID"

  # ======================================================
  # Terraform Init (Backend defined in provider.tf)
  # ======================================================
  - script: |
      terraform init \
        -backend-config="resource_group_name=tfstate-rg" \
        -backend-config="storage_account_name=tfstatestoracct01" \
        -backend-config="container_name=tfstate" \
        -backend-config="key=$(environment).tfstate"
    workingDirectory: terraform
    displayName: "Terraform Init"

  # ======================================================
  # Terraform Validate
  # ======================================================
  - script: terraform validate
    workingDirectory: terraform
    displayName: "Terraform Validate"

  # ======================================================
  # Terraform Plan (environment-specific)
  # ======================================================
  - script: |
      terraform plan -var-file="../environment/$(environment).tfvars"
    workingDirectory: terraform
    displayName: "Terraform Plan"
